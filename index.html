<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111827">
  <meta charset="UTF-8" />
  <title>Employee Connect â€“ Multi Company + Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;font-family:Tahoma,Arial,sans-serif;background:#f3f4f6}
    .hidden{display:none}
    header{background:#111827;color:#fff;padding:12px 20px}
    header h2{margin:0;font-size:18px}
    .card{background:#fff;border-radius:8px;padding:12px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,.1)}
    input,select,button,textarea{width:100%;padding:7px;margin:4px 0 8px 0;font-family:inherit;font-size:13px}
    button{cursor:pointer;background:#2563eb;color:#fff;border:none;border-radius:4px}
    button.secondary{background:#10b981}
    button.danger{background:#dc2626}
    .container{display:flex;min-height:100vh}
    aside{width:280px;background:#1f2937;color:#fff;padding:15px}
    main{flex:1;padding:16px}
    .role-pill{background:#dbeafe;color:#1e3a8a;padding:3px 7px;border-radius:999px;font-size:11px;display:inline-block;margin-top:4px}
    #welcomeBox{background:#ecfeff;border-right:4px solid #06b6d4}
    .stats-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}
    .stat-box{flex:1 1 120px;background:#f9fafb;border-radius:6px;padding:8px 10px;font-size:13px;border:1px solid #e5e7eb}
    .stat-label{color:#6b7280;font-size:11px}
    .stat-value{font-size:18px;font-weight:bold}
    .filters{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    @media(max-width:800px){.container{flex-direction:column}aside{width:100%}}
    @media(max-width:650px){.filters{grid-template-columns:repeat(1,minmax(0,1fr))}}
    .skill-item{display:flex;justify-content:space-between;font-size:13px;padding:4px 0;border-bottom:1px solid #f3f4f6}
    .skill-name{font-weight:bold}
    .skill-count{color:#2563eb}
    .emp-row{border-bottom:1px solid #f3f4f6;padding:6px 0}
    .emp-header{display:flex;justify-content:space-between;align-items:center;gap:8px;font-size:13px}
    .emp-name{font-weight:bold}
    .emp-meta{font-size:11px;color:#6b7280}
    .tag{background:#e5e7eb;padding:2px 6px;border-radius:999px;font-size:11px;margin:2px 4px 0 0;display:inline-block}
    .status-pill{font-weight:bold}
    .status-ON{color:#16a34a}
    .status-VACATION{color:#f59e0b}
    .status-REMOTE{color:#2563eb}
    .status-OUT{color:#dc2626}
    .status-select{width:auto;font-size:11px}
    textarea{resize:vertical;min-height:50px}
    .small-hint{font-size:11px;color:#9ca3af}
    .admin-section-title{font-size:13px;margin:6px 0 4px 0;border-bottom:1px solid #4b5563;padding-bottom:3px}
    .checkbox-group label{display:block;font-size:12px;margin:2px 0}
    .profile-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    @media(max-width:700px){.profile-grid{grid-template-columns:1fr}}
    .profile-title{font-size:14px;font-weight:bold;margin-bottom:6px}
    .link-btn{background:none;border:none;padding:0;margin:0;font:inherit;color:#2563eb;cursor:pointer;text-decoration:underline}
    .field-label{font-size:12px;color:#374151}
    .readonly{background:#f9fafb;color:#6b7280}
  </style>
</head>
<body>
<header>
  <h2>Employee Connect â€“ Multi Company Demo</h2>
</header>

<!-- LOGIN VIEW -->
<div id="loginView" class="card" style="max-width:460px;margin:40px auto">
  <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>

  <label class="field-label">Ø§Ù„Ø´Ø±ÙƒØ©</label>
  <select id="loginCompany"></select>

  <label class="field-label">Ø§Ù„Ø¯ÙˆØ±</label>
  <select id="loginRole">
    <option value="SUPER">Super Admin</option>
    <option value="COMPANY_ADMIN">Company Admin</option>
    <option value="DEPT_MANAGER">Department Manager</option>
    <option value="EMPLOYEE">Employee</option>
  </select>

  <label class="field-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
  <input id="loginName" placeholder="Ù…Ø«Ø§Ù„: ÙØ§ÙŠØ² Ø§Ù„Ø¹Ù†Ø²ÙŠ" />

  <div id="loginDeptGroup">
    <label class="field-label">Ù‚Ø³Ù…Ùƒ</label>
    <select id="loginDept"></select>
    <div class="small-hint">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø°ÙŠ ØªØ¹Ù…Ù„ ÙÙŠÙ‡ Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…Ø¯ÙŠØ± Ù‚Ø³Ù… Ø£Ùˆ Ù…ÙˆØ¸Ù.</div>
  </div>

  <div id="loginDeptAlert" class="small-hint" style="color:#b91c1c;display:none;">
    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¹Ø¯. Ø§Ø¯Ø®Ù„ ÙƒÙ€ Super Admin Ø£Ùˆ Company Admin Ø«Ù… Ø£Ø¶Ù Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.
  </div>

  <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- APP VIEW -->
<div id="appView" class="hidden">
  <div class="container">

    <!-- SIDEBAR -->
    <aside>
      <div id="userInfo" class="card" style="background:#111827;border:none;box-shadow:none;margin-bottom:10px;"></div>

      <div id="adminPanel" class="card hidden" style="background:#111827;border:none;">
        <div class="admin-section-title">Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
        <div id="currentCompanyLabel" class="small-hint" style="color:#e5e7eb;margin-bottom:6px;"></div>

        <div class="admin-section-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
        <input id="newDeptName" placeholder="Ø§Ø³Ù… Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ø§Ù„: IT)" />
        <button id="addDeptBtn" class="secondary">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>

        <div class="small-hint">Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ù‚Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯:</div>
        <select id="editDeptSelect"></select>
        <input id="editDeptName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù‚Ø³Ù…" />
        <button id="renameDeptBtn">ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…</button>

        <div class="admin-section-title">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</div>
        <input id="empName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" />
        <select id="empDept"></select>
        <input id="empEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
        <input id="empPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" />
        <select id="empStatus">
          <option value="ON">Ù…Ø¯Ø§ÙˆÙ…</option>
          <option value="VACATION">Ø¥Ø¬Ø§Ø²Ø©</option>
          <option value="REMOTE">Ø¹Ù† Ø¨ÙØ¹Ø¯</option>
          <option value="OUT">Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ÙƒØªØ¨</option>
        </select>
        <textarea id="empSkills" placeholder="Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø© Ø£Ùˆ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)"></textarea>
        <button id="addEmpBtn" class="secondary">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù</button>

        <div class="admin-section-title">ØµÙ„Ø§Ø­ÙŠØ§Øª Ø±Ø¤ÙŠØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
        <div class="small-hint">
          Ù„ÙƒÙ„ Ù‚Ø³Ù…ØŒ Ø­Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰ Ø§Ù„ØªÙŠ ÙŠØ³ØªØ·ÙŠØ¹ Ø±Ø¤ÙŠØ© Ù…ÙˆØ¸ÙÙŠÙ‡Ø§ (Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…).
        </div>
        <label class="field-label">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ¯Ø±</label>
        <select id="srcDept"></select>
        <label class="field-label">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø±Ø¤ÙŠØªÙ‡Ø§</label>
        <div id="targetDepts" class="checkbox-group"></div>
        <button id="savePermsBtn">Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</button>
      </div>

      <button id="logoutBtn" style="margin-top:8px;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </aside>

    <!-- MAIN -->
    <main>
      <!-- Welcome -->
      <div id="welcomeBox" class="card"></div>

      <!-- DASHBOARD STATS -->
      <div class="card">
        <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</h3>
        <div class="stats-row">
          <div class="stat-box">
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ø¯Ø§Ø®Ù„ Ø´Ø±ÙƒØªÙƒ ÙˆØ­Ø³Ø¨ ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ)</div>
            <div id="statTotal" class="stat-value">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Ù…Ø¯Ø§ÙˆÙ… Ø§Ù„Ø¢Ù†</div>
            <div id="statOn" class="stat-value">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Ø¥Ø¬Ø§Ø²Ø©</div>
            <div id="statVac" class="stat-value">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Ø¹Ù† Ø¨ÙØ¹Ø¯ / Ø®Ø§Ø±Ø¬</div>
            <div id="statOther" class="stat-value">0</div>
          </div>
        </div>
      </div>

      <!-- SMART SEARCH -->
      <div class="card">
        <h3>Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø¹Ù† Ù…ÙˆØ¸Ù ÙŠØ³Ø§Ø¹Ø¯Ùƒ</h3>
        <div class="filters">
          <div>
            <label class="field-label">Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… / Ø¥ÙŠÙ…ÙŠÙ„ / Ø¬ÙˆØ§Ù„</label>
            <input id="searchText" placeholder="Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„..." />
          </div>
          <div>
            <label class="field-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="statusFilter">
              <option value="ALL">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
              <option value="ON">Ù…Ø¯Ø§ÙˆÙ… Ø§Ù„Ø¢Ù†</option>
              <option value="VACATION">Ø¥Ø¬Ø§Ø²Ø©</option>
              <option value="REMOTE">Ø¹Ù† Ø¨ÙØ¹Ø¯</option>
              <option value="OUT">Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ÙƒØªØ¨</option>
            </select>
          </div>
          <div>
            <label class="field-label">Ø£Ø­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ù…Ù‡Ø§Ø±Ø©</label>
            <select id="skillFilter">
              <option value="ALL">ÙƒÙ„ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</option>
            </select>
          </div>
        </div>
        <div class="small-hint" style="margin-top:4px;">
          Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªØ­ØªØ±Ù…: Ø§Ù„Ø´Ø±ÙƒØ© + ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø¯ÙˆØ±Ùƒ.
        </div>
      </div>

      <!-- SKILLS DISTRIBUTION -->
      <div class="card">
        <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª (Ø¯Ø§Ø®Ù„ Ø­Ø¯ÙˆØ¯ ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ)</h3>
        <div id="skillsList"></div>
      </div>

      <!-- PROFILE CARD -->
      <div id="profileCard" class="card hidden">
        <div class="profile-title">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù„Ù…ÙˆØ¸Ù</div>
        <div class="profile-grid">
          <div>
            <label class="field-label">Ø§Ù„Ø§Ø³Ù…</label>
            <input id="profileName" class="readonly" readonly />
          </div>
          <div>
            <label class="field-label">Ø§Ù„Ù‚Ø³Ù…</label>
            <select id="profileDept"></select>
          </div>
          <div>
            <label class="field-label">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
            <input id="profileEmail" />
          </div>
          <div>
            <label class="field-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
            <input id="profilePhone" />
          </div>
          <div>
            <label class="field-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="profileStatus">
              <option value="ON">Ù…Ø¯Ø§ÙˆÙ…</option>
              <option value="VACATION">Ø¥Ø¬Ø§Ø²Ø©</option>
              <option value="REMOTE">Ø¹Ù† Ø¨ÙØ¹Ø¯</option>
              <option value="OUT">Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ÙƒØªØ¨</option>
            </select>
          </div>
        </div>
        <div>
          <label class="field-label">Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª (Ø³Ø·Ø± Ù„ÙƒÙ„ Ù…Ù‡Ø§Ø±Ø© Ø£Ùˆ ÙØ§ØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)</label>
          <textarea id="profileSkills"></textarea>
        </div>
        <div class="small-hint">
          Ø§Ù„Ù…ÙˆØ¸Ù ÙŠÙ‚Ø¯Ø± ÙŠØ¹Ø¯Ù‘Ù„ Ù…Ù„ÙÙ‡ ÙÙ‚Ø·ØŒ ÙˆØ§Ù„Ù…Ø¯ÙŠØ±/Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠÙ‚Ø¯Ø± ÙŠØ¹Ø¯Ù‘Ù„ Ù…ÙˆØ¸ÙÙŠ Ø§Ù„Ø´Ø±ÙƒØ© Ø­Ø³Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù….
        </div>
        <div style="display:flex;gap:8px;margin-top:4px;flex-wrap:wrap;">
          <button id="profileSaveBtn" class="secondary" style="flex:0 0 120px;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
          <button id="profileCancelBtn" style="flex:0 0 120px;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <!-- EMPLOYEES LIST -->
      <div class="card">
        <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†</h3>
        <div id="employeesList"></div>
      </div>
    </main>
  </div>
</div>

<script>
  // ====== STORAGE KEY ======
  const KEY = "EC_MULTI_COMPANY_PROFILE_V1";

  // ====== DEFAULT DATA (Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„ ÙÙ‚Ø·) ======
  let data = JSON.parse(localStorage.getItem(KEY) || "null") || {
    companies: [
      { id: 1, name: "Ø´Ø±ÙƒØ© ÙØ§ÙŠØ² Ù„Ù„ØªÙ‚Ù†ÙŠØ©" },
      { id: 2, name: "Ø´Ø±ÙƒØ© ØªØ¬Ø±ÙŠØ¨ÙŠØ©" }
    ],
    departments: [
      { id: 1, companyId: 1, name: "IT" },
      { id: 2, companyId: 1, name: "HR" },
      { id: 3, companyId: 1, name: "SALES" },
      { id: 4, companyId: 1, name: "FIN" },
      { id: 5, companyId: 2, name: "IT" },
      { id: 6, companyId: 2, name: "Support" }
    ],
    employees: [
      {
        id: 1,
        companyId: 1,
        name: "ÙØ§ÙŠØ² Ø§Ù„Ø¹Ù†Ø²ÙŠ",
        deptId: 1,
        status: "ON",
        email: "fayez@example.com",
        phone: "0550000000",
        skills: ["Ø´Ø¨ÙƒØ§Øª", "Microsoft 365", "Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"]
      },
      {
        id: 2,
        companyId: 1,
        name: "Ø±Ù†Ø§ Ø§Ù„Ø´Ù‡Ø±ÙŠ",
        deptId: 2,
        status: "VACATION",
        email: "rana@example.com",
        phone: "0551111111",
        skills: ["Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ©", "Ø¥Ø¬Ø§Ø²Ø§Øª"]
      },
      {
        id: 3,
        companyId: 1,
        name: "Ø£Ø­Ù…Ø¯ Ø§Ù„ÙÙŠÙÙŠ",
        deptId: 1,
        status: "REMOTE",
        email: "ahmad@example.com",
        phone: "0552222222",
        skills: ["Ø´Ø¨ÙƒØ§Øª", "Ù…ÙŠØ¯Ø§Ù†ÙŠ"]
      },
      {
        id: 4,
        companyId: 1,
        name: "Ù†ÙˆØ§Ù„ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ",
        deptId: 3,
        status: "ON",
        email: "nawal@example.com",
        phone: "0553333333",
        skills: ["Ù…Ø¨ÙŠØ¹Ø§Øª", "Ø¹Ù…Ù„Ø§Ø¡"]
      },
      {
        id: 5,
        companyId: 2,
        name: "Ø³Ø¹ÙˆØ¯ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ",
        deptId: 5,
        status: "ON",
        email: "saud@example.com",
        phone: "0554444444",
        skills: ["Ø¯Ø¹Ù… ÙÙ†ÙŠ", "Ø´Ø¨ÙƒØ§Øª"]
      }
    ],
    // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: Ù…ÙØªØ§Ø­ Ø¹Ù„Ù‰ Ø´ÙƒÙ„ companyId:deptId => [deptId,... Ø¶Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø´Ø±ÙƒØ©]
    perms: {
      "1:1": [1, 2, 3, 4],
      "1:2": [2],
      "1:3": [3, 1],
      "1:4": [4],
      "2:5": [5, 6],
      "2:6": [6]
    }
  };

  function saveData() {
    localStorage.setItem(KEY, JSON.stringify(data));
  }

  // ====== SESSION ======
  let session = null; // { name, role, companyId, deptId? }
  let currentProfileId = null;

  // ====== ELEMENTS ======
  const loginView        = document.getElementById("loginView");
  const loginCompany     = document.getElementById("loginCompany");
  const loginRole        = document.getElementById("loginRole");
  const loginName        = document.getElementById("loginName");
  const loginDeptGroup   = document.getElementById("loginDeptGroup");
  const loginDept        = document.getElementById("loginDept");
  const loginDeptAlert   = document.getElementById("loginDeptAlert");
  const loginBtn         = document.getElementById("loginBtn");

  const appView    = document.getElementById("appView");
  const userInfo   = document.getElementById("userInfo");
  const adminPanel = document.getElementById("adminPanel");
  const currentCompanyLabel = document.getElementById("currentCompanyLabel");
  const logoutBtn  = document.getElementById("logoutBtn");

  const welcomeBox   = document.getElementById("welcomeBox");
  const statTotal    = document.getElementById("statTotal");
  const statOn       = document.getElementById("statOn");
  const statVac      = document.getElementById("statVac");
  const statOther    = document.getElementById("statOther");
  const skillsList   = document.getElementById("skillsList");
  const employeesList= document.getElementById("employeesList");

  const searchText   = document.getElementById("searchText");
  const statusFilter = document.getElementById("statusFilter");
  const skillFilter  = document.getElementById("skillFilter");

  const newDeptName    = document.getElementById("newDeptName");
  const addDeptBtn     = document.getElementById("addDeptBtn");
  const editDeptSelect = document.getElementById("editDeptSelect");
  const editDeptName   = document.getElementById("editDeptName");
  const renameDeptBtn  = document.getElementById("renameDeptBtn");

  const empName   = document.getElementById("empName");
  const empDept   = document.getElementById("empDept");
  const empEmail  = document.getElementById("empEmail");
  const empPhone  = document.getElementById("empPhone");
  const empStatus = document.getElementById("empStatus");
  const empSkills = document.getElementById("empSkills");
  const addEmpBtn = document.getElementById("addEmpBtn");

  const srcDept    = document.getElementById("srcDept");
  const targetDepts= document.getElementById("targetDepts");
  const savePermsBtn = document.getElementById("savePermsBtn");

  const profileCard   = document.getElementById("profileCard");
  const profileName   = document.getElementById("profileName");
  const profileDept   = document.getElementById("profileDept");
  const profileEmail  = document.getElementById("profileEmail");
  const profilePhone  = document.getElementById("profilePhone");
  const profileStatus = document.getElementById("profileStatus");
  const profileSkills = document.getElementById("profileSkills");
  const profileSaveBtn= document.getElementById("profileSaveBtn");
  const profileCancelBtn = document.getElementById("profileCancelBtn");

  // ====== HELPERS ======
  function roleLabel(role) {
    return {
      SUPER: "Super Admin (Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù…)",
      COMPANY_ADMIN: "Ø£Ø¯Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ©",
      DEPT_MANAGER: "Ù…Ø¯ÙŠØ± Ù‚Ø³Ù…",
      EMPLOYEE: "Ù…ÙˆØ¸Ù"
    }[role] || role;
  }

  function permKey(companyId, deptId) {
    return companyId + ":" + deptId;
  }

  function ensurePermEntry(companyId, deptId) {
    const key = permKey(companyId, deptId);
    if (!data.perms[key]) data.perms[key] = [deptId];
  }

  function getCompanyById(id) {
    return data.companies.find(c => c.id === id);
  }

  function getDeptsByCompany(companyId) {
    return data.departments.filter(d => d.companyId === companyId);
  }

  function getEmpsByCompany(companyId) {
    return data.employees.filter(e => e.companyId === companyId);
  }

  function getAllowedDeptIdsForSession() {
    if (!session) return [];
    const companyId = session.companyId;
    if (session.role === "SUPER" || session.role === "COMPANY_ADMIN") {
      return getDeptsByCompany(companyId).map(d => d.id);
    }
    if (!session.deptId) return [];
    const key = permKey(companyId, session.deptId);
    const arr = data.perms[key];
    if (!arr || !arr.length) return [session.deptId];
    return arr.slice();
  }

  function canEditEmployee(emp) {
    if (!session) return false;
    if (emp.companyId !== session.companyId) return false;

    if (session.role === "SUPER" || session.role === "COMPANY_ADMIN") return true;

    const allowedDepts = getAllowedDeptIdsForSession();

    if (session.role === "DEPT_MANAGER") {
      return allowedDepts.includes(emp.deptId);
    }
    if (session.role === "EMPLOYEE") {
      return emp.name === session.name;
    }
    return false;
  }

  // ====== INIT LOGIN COMPANIES ======
  function refreshLoginCompanies() {
    loginCompany.innerHTML = "";
    data.companies.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name;
      loginCompany.appendChild(opt);
    });
  }

  function refreshLoginDeptsForCompany(companyId) {
    loginDept.innerHTML = "";
    const depts = getDeptsByCompany(companyId);
    if (!depts.length) {
      loginDeptAlert.style.display = "block";
      return;
    }
    loginDeptAlert.style.display = "none";
    depts.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.name;
      loginDept.appendChild(opt);
    });
  }

  refreshLoginCompanies();
  refreshLoginDeptsForCompany(parseInt(loginCompany.value || "1", 10));

  loginCompany.addEventListener("change", () => {
    const cid = parseInt(loginCompany.value, 10);
    const role = loginRole.value;
    if (role === "DEPT_MANAGER" || role === "EMPLOYEE") {
      refreshLoginDeptsForCompany(cid);
    }
  });

  loginRole.addEventListener("change", () => {
    const role = loginRole.value;
    const cid = parseInt(loginCompany.value, 10);
    if (role === "SUPER" || role === "COMPANY_ADMIN") {
      loginDeptGroup.style.display = "none";
      loginDeptAlert.style.display = "none";
    } else {
      loginDeptGroup.style.display = "block";
      refreshLoginDeptsForCompany(cid);
    }
  });

  // ====== LOGIN / LOGOUT ======
  loginBtn.addEventListener("click", () => {
    const name = (loginName.value || "").trim();
    if (!name) {
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
      return;
    }
    const role = loginRole.value;
    const companyId = parseInt(loginCompany.value, 10);
    let deptId = null;

    if (role === "DEPT_MANAGER" || role === "EMPLOYEE") {
      const depts = getDeptsByCompany(companyId);
      if (!depts.length) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙƒØ©. Ø§Ø³ØªØ®Ø¯Ù… Super Admin Ø£Ùˆ Company Admin Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ù‚Ø³Ø§Ù….");
        return;
      }
      deptId = parseInt(loginDept.value, 10);
    }

    session = { name, role, companyId, deptId };
    loginView.classList.add("hidden");
    appView.classList.remove("hidden");
    initApp();
  });

  logoutBtn.addEventListener("click", () => {
    session = null;
    appView.classList.add("hidden");
    loginView.classList.remove("hidden");
    currentProfileId = null;
    profileCard.classList.add("hidden");
  });

  // ====== APP INIT ======
  function initApp() {
    const company = getCompanyById(session.companyId);
    const dept = session.deptId
      ? data.departments.find(d => d.id === session.deptId)
      : null;

    userInfo.innerHTML = `
      <div style="font-size:14px;font-weight:bold;">${session.name}</div>
      <div class="role-pill">${roleLabel(session.role)}</div>
      <div style="font-size:11px;color:#9ca3af;margin-top:4px;">
        Ø§Ù„Ø´Ø±ÙƒØ©: ${company ? company.name : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©"}<br>
        ${dept ? "Ø§Ù„Ù‚Ø³Ù…: " + dept.name : ""}
      </div>
    `;

    currentCompanyLabel.textContent = company ? company.name : "";

    if (session.role === "SUPER" || session.role === "COMPANY_ADMIN") {
      adminPanel.classList.remove("hidden");
    } else {
      adminPanel.classList.add("hidden");
    }

    refreshAdminDeptSelectors();
    renderTargetDepts();

    searchText.addEventListener("input", renderMain);
    statusFilter.addEventListener("change", renderMain);
    skillFilter.addEventListener("change", renderMain);

    addDeptBtn.addEventListener("click", onAddDept);
    renameDeptBtn.addEventListener("click", onRenameDept);
    addEmpBtn.addEventListener("click", onAddEmployee);
    srcDept.addEventListener("change", renderTargetDepts);
    savePermsBtn.addEventListener("click", onSavePerms);

    profileSaveBtn.addEventListener("click", onProfileSave);
    profileCancelBtn.addEventListener("click", () => {
      currentProfileId = null;
      profileCard.classList.add("hidden");
    });

    renderMain();
  }

  // ====== ADMIN: DEPARTMENTS ======
  function refreshAdminDeptSelectors() {
    const cid = session.companyId;
    const companyDepts = getDeptsByCompany(cid);

    // editDeptSelect
    editDeptSelect.innerHTML = "";
    companyDepts.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.name;
      editDeptSelect.appendChild(opt);
    });

    // empDept
    empDept.innerHTML = "";
    companyDepts.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.name;
      empDept.appendChild(opt);
    });

    // profileDept
    profileDept.innerHTML = "";
    companyDepts.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.name;
      profileDept.appendChild(opt);
    });

    // srcDept for permissions
    srcDept.innerHTML = "";
    companyDepts.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.name;
      srcDept.appendChild(opt);
    });
  }

  function onAddDept() {
    const name = (newDeptName.value || "").trim();
    if (!name) {
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù….");
      return;
    }
    const newId = data.departments.length ? Math.max(...data.departments.map(d => d.id)) + 1 : 1;
    data.departments.push({
      id: newId,
      companyId: session.companyId,
      name
    });
    saveData();
    newDeptName.value = "";
    refreshAdminDeptSelectors();
    renderMain();
    alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­ âœ…");
  }

  function onRenameDept() {
    const deptId = parseInt(editDeptSelect.value, 10);
    const newName = (editDeptName.value || "").trim();
    if (!deptId || !newName) {
      alert("Ø§Ø®ØªØ± Ù‚Ø³Ù… ÙˆØ§ÙƒØªØ¨ Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯.");
      return;
    }
    const d = data.departments.find(x => x.id === deptId && x.companyId === session.companyId);
    if (!d) return;
    d.name = newName;
    saveData();
    editDeptName.value = "";
    refreshAdminDeptSelectors();
    renderMain();
    alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… âœ…");
  }

  // ====== ADMIN: EMPLOYEES ======
  function onAddEmployee() {
    const name = (empName.value || "").trim();
    const deptId = parseInt(empDept.value, 10);
    const email = (empEmail.value || "").trim();
    const phone = (empPhone.value || "").trim();
    const status = empStatus.value;
    const skillsRaw = (empSkills.value || "");

    if (!name || !deptId) {
      alert("Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‚Ø³Ù… Ù…Ø·Ù„ÙˆØ¨Ø§Ù†.");
      return;
    }

    const skills = skillsRaw
      .split(/[\n,]/)
      .map(s => s.trim())
      .filter(Boolean);

    const newId = data.employees.length ? Math.max(...data.employees.map(e => e.id)) + 1 : 1;
    data.employees.push({
      id: newId,
      companyId: session.companyId,
      name,
      deptId,
      status,
      email,
      phone,
      skills
    });
    saveData();

    empName.value = "";
    empEmail.value = "";
    empPhone.value = "";
    empSkills.value = "";
    empStatus.value = "ON";

    refreshSkillFilter();
    renderMain();
    alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­ âœ…");
  }

  // ====== ADMIN: PERMISSIONS ======
  function renderTargetDepts() {
    targetDepts.innerHTML = "";
    const cid = session.companyId;
    const companyDepts = getDeptsByCompany(cid);
    const srcId = parseInt(srcDept.value || (companyDepts[0] && companyDepts[0].id) || "0", 10);
    if (!srcId) return;
    ensurePermEntry(cid, srcId);
    const key = permKey(cid, srcId);
    const allowed = new Set(data.perms[key] || []);

    companyDepts.forEach(d => {
      const id = "perm_" + d.id;
      const checked = allowed.has(d.id);
      const label = document.createElement("label");
      label.innerHTML = `
        <input type="checkbox" id="${id}" ${checked ? "checked" : ""}>
        ${d.name}
      `;
      targetDepts.appendChild(label);
    });
  }

  function onSavePerms() {
    const cid = session.companyId;
    const srcId = parseInt(srcDept.value || "0", 10);
    if (!srcId) {
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ¯Ø±.");
      return;
    }
    const companyDepts = getDeptsByCompany(cid);
    const selected = [];
    companyDepts.forEach(d => {
      const chk = document.getElementById("perm_" + d.id);
      if (chk && chk.checked) selected.push(d.id);
    });
    if (!selected.length) {
      alert("ÙŠÙØ¶Ù„ Ø£Ù† ØªØ³Ù…Ø­ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø¨Ø§Ù„Ù‚Ø³Ù… Ù†ÙØ³Ù‡.");
      return;
    }
    data.perms[permKey(cid, srcId)] = selected;
    saveData();
    renderMain();
    alert("ØªÙ… Ø­ÙØ¸ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… âœ…");
  }

  // ====== SKILLS FILTER ======
  function refreshSkillFilter() {
    const allowedDepts = getAllowedDeptIdsForSession();
    const cid = session.companyId;

    skillFilter.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "ALL";
    optAll.textContent = "ÙƒÙ„ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª";
    skillFilter.appendChild(optAll);

    const set = new Set();
    getEmpsByCompany(cid)
      .filter(e => allowedDepts.includes(e.deptId))
      .forEach(e => {
        (e.skills || []).forEach(s => {
          if (s && s.trim()) set.add(s.trim());
        });
      });

    Array.from(set).sort().forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      skillFilter.appendChild(opt);
    });
  }

  // ====== MAIN RENDER ======
  function renderMain() {
    if (!session) return;
    const company = getCompanyById(session.companyId);
    const dept = session.deptId
      ? data.departments.find(d => d.id === session.deptId)
      : null;

    welcomeBox.innerHTML = `
      ğŸ‘‹ Ù…Ø±Ø­Ø¨Ù‹Ø§ <b>${session.name}</b><br>
      Ø§Ù„Ø´Ø±ÙƒØ©: <b>${company ? company.name : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©"}</b><br>
      Ø¯ÙˆØ±Ùƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…: <b>${roleLabel(session.role)}</b><br>
      ${
        dept
          ? `Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„ Ù„Ùƒ: <b>${dept.name}</b><br>`
          : ""
      }
      ${
        session.role === "SUPER" || session.role === "COMPANY_ADMIN"
          ? `ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø£Ù‚Ø³Ø§Ù… ÙˆÙ…ÙˆØ¸ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙƒØ©ØŒ ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø¨ØµÙ„Ø§Ø­ÙŠØ§Øª Ø±Ø¤ÙŠØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©.`
          : `ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ ÙˆØ§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø¹Ø±Ø¶ Ù…Ù„ÙÙ‡ Ø§Ù„Ø´Ø®ØµÙŠØŒ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø£Ù†Øª ÙÙ‚Ø·.`
      }
    `;

    const cid = session.companyId;
    const allowedDepts = getAllowedDeptIdsForSession();
    const empsVisible = getEmpsByCompany(cid).filter(e => allowedDepts.includes(e.deptId));

    const total = empsVisible.length;
    let on = 0, vac = 0, other = 0;
    empsVisible.forEach(e => {
      if (e.status === "ON") on++;
      else if (e.status === "VACATION") vac++;
      else other++;
    });
    statTotal.textContent = total;
    statOn.textContent = on;
    statVac.textContent = vac;
    statOther.textContent = other;

    refreshSkillFilter();
    renderSkills(empsVisible);
    renderEmployeesList(empsVisible);
  }

  // ====== SKILLS DISTRIBUTION ======
  function renderSkills(empsVisible) {
    const map = {};
    empsVisible.forEach(e => {
      (e.skills || []).forEach(s => {
        if (!map[s]) map[s] = 0;
        map[s]++;
      });
    });
    const skills = Object.keys(map).sort((a, b) => map[b] - map[a]);
    if (!skills.length) {
      skillsList.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù†Ø·Ø§Ù‚ ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ.";
      return;
    }
    skillsList.innerHTML = skills.map(s => `
      <div class="skill-item">
        <span class="skill-name">${s}</span>
        <span class="skill-count">${map[s]} Ù…ÙˆØ¸Ù</span>
      </div>
    `).join("");
  }

  // ====== EMPLOYEES LIST ======
  function labelStatus(code) {
    return {
      ON: "Ù…Ø¯Ø§ÙˆÙ…",
      VACATION: "Ø¥Ø¬Ø§Ø²Ø©",
      REMOTE: "Ø¹Ù† Ø¨ÙØ¹Ø¯",
      OUT: "Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ÙƒØªØ¨"
    }[code] || code;
  }

  function renderEmployeesList(empsVisible) {
    const text   = (searchText.value || "").toLowerCase().trim();
    const stFilt = statusFilter.value;
    const skFilt = skillFilter.value;

    let list = empsVisible.slice();

    if (text) {
      list = list.filter(e => {
        const hay = (
          (e.name  || "") + " " +
          (e.email || "") + " " +
          (e.phone || "")
        ).toLowerCase();
        return hay.includes(text);
      });
    }

    if (stFilt !== "ALL") list = list.filter(e => e.status === stFilt);
    if (skFilt !== "ALL") list = list.filter(e => (e.skills || []).includes(skFilt));

    if (!list.length) {
      employeesList.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.";
      return;
    }

    employeesList.innerHTML = list.map(e => {
      const dept = data.departments.find(d => d.id === e.deptId);
      const deptName = dept ? dept.name : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

      const emailHtml = e.email
        ? `<a href="mailto:${e.email}">${e.email}</a>`
        : "-";
      const phoneHtml = e.phone
        ? `<a href="tel:${e.phone}">${e.phone}</a>`
        : "-";

      const canEditThis = canEditEmployee(e);
      const statusSelectHtml = canEditThis
        ? `
        <select class="status-select" onchange="changeStatus(${e.id}, this.value)">
          <option value="ON" ${e.status === "ON" ? "selected" : ""}>Ù…Ø¯Ø§ÙˆÙ…</option>
          <option value="VACATION" ${e.status === "VACATION" ? "selected" : ""}>Ø¥Ø¬Ø§Ø²Ø©</option>
          <option value="REMOTE" ${e.status === "REMOTE" ? "selected" : ""}>Ø¹Ù† Ø¨ÙØ¹Ø¯</option>
          <option value="OUT" ${e.status === "OUT" ? "selected" : ""}>Ø®Ø§Ø±Ø¬</option>
        </select>
      `
        : "";

      return `
        <div class="emp-row">
          <div class="emp-header">
            <div>
              <button class="link-btn" onclick="openProfile(${e.id})">${e.name}</button>
              <div class="emp-meta">Ø§Ù„Ù‚Ø³Ù…: ${deptName}</div>
              <div class="emp-meta">ğŸ“§ ${emailHtml} &nbsp;|&nbsp; ğŸ“± ${phoneHtml}</div>
            </div>
            <div style="text-align:left;">
              <span class="tag status-pill status-${e.status}">${labelStatus(e.status)}</span>
              ${statusSelectHtml}
            </div>
          </div>
          <div style="margin-top:4px;">
            ${(e.skills || []).map(s => `<span class="tag">${s}</span>`).join("")}
          </div>
        </div>
      `;
    }).join("");
  }

  // ====== PROFILE LOGIC ======
  function fillProfileDeptOptionsForCompany(companyId) {
    profileDept.innerHTML = "";
    getDeptsByCompany(companyId).forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.name;
      profileDept.appendChild(opt);
    });
  }

  window.openProfile = function(id) {
    const emp = data.employees.find(e => e.id === id);
    if (!emp) return;
    currentProfileId = id;

    fillProfileDeptOptionsForCompany(emp.companyId);

    profileName.value   = emp.name;
    profileEmail.value  = emp.email || "";
    profilePhone.value  = emp.phone || "";
    profileStatus.value = emp.status;
    profileDept.value   = emp.deptId;
    profileSkills.value = (emp.skills || []).join("\n");

    const editable = canEditEmployee(emp);

    profileDept.disabled   = !editable || session.role === "EMPLOYEE";
    profileEmail.disabled  = !editable;
    profilePhone.disabled  = !editable;
    profileStatus.disabled = !editable;
    profileSkills.disabled = !editable;

    profileSaveBtn.style.display = editable ? "inline-block" : "none";

    profileCard.classList.remove("hidden");
  };

  function onProfileSave() {
    if (!currentProfileId) return;
    const emp = data.employees.find(e => e.id === currentProfileId);
    if (!emp) return;

    if (!canEditEmployee(emp)) {
      alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù.");
      return;
    }

    const deptId = parseInt(profileDept.value, 10);
    const email  = (profileEmail.value || "").trim();
    const phone  = (profilePhone.value || "").trim();
    const status = profileStatus.value;
    const skillsRaw = (profileSkills.value || "");

    emp.deptId = deptId;
    emp.email  = email;
    emp.phone  = phone;
    emp.status = status;
    emp.skills = skillsRaw
      .split(/[\n,]/)
      .map(s => s.trim())
      .filter(Boolean);

    saveData();
    renderMain();
    alert("ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù âœ…");
  }

  // ====== CHANGE STATUS (INLINE) ======
  window.changeStatus = function(id, newStatus) {
    const emp = data.employees.find(e => e.id === id);
    if (!emp) return;
    if (!canEditEmployee(emp)) {
      alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù.");
      return;
    }
    emp.status = newStatus;
    saveData();
    renderMain();
  };
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log('Service Worker registered successfully'))
    .catch(err => console.error('Service Worker registration failed:', err));
}
</script>
</body>
</html>